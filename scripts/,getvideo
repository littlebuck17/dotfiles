#!/bin/bash

cd ${HOME}/Movies
ytdlp=$(which yt-dlp)
#sudo ${ytdlp} -U
sudo ${ytdlp} --update-to nightly
#filename=$(${ytdlp} --cookies ${HOME}/cookies.SocialMedia.txt --user-agent facebookexternalhit/1.1 --windows-filenames --get-filename "${1}")

if [[ "${1}" =~ "tiktok.com" ]]; then
    filename=$(${ytdlp} --extractor-args "tiktok:api_hostname=api22-normal-c-useast2a.tiktokv.com" --user-agent facebookexternalhit/1.1 --windows-filenames --get-filename "${1}")
else
    filename=$(${ytdlp} --user-agent facebookexternalhit/1.1 --windows-filenames --get-filename "${1}")
fi

#filename="@StarTrekGuy  [7304431911953255722].mp4"

fullname=$(echo -n "${filename%.*}" | sed -e 's/[^[:alnum:]]/-/g' | tr -s '-' | sed -e 's/^-//' | sed -e 's/-$//')
videoid="${fullname##*-}"
name="${fullname%-*}"
ext="${filename##*.}"
file="${name:0:40}-${videoid}.mp4"

echo "${name} - ${videoid} - ${ext} - ${file}"

#${ytdlp} --cookies ${HOME}/cookies.SocialMedia.txt --user-agent facebookexternalhit/1.1 --windows-filenames -o "${file}" "${1}"

#--extractor-args "tiktok:api_hostname=api22-normal-c-useast2a.tiktokv.com" \
if [[ "${1}" =~ "tiktok.com" ]]; then
    ${ytdlp} -S res,ext:mp4:m4a --recode mp4 --user-agent facebookexternalhit/1.1 \
        --windows-filenames -o "${file}" \
        "${1}"
else
    ${ytdlp} -S res,ext:mp4:m4a --recode mp4 --user-agent facebookexternalhit/1.1 --windows-filenames -o "${file}" "${1}"
fi

telegram-send --video "${file}" --caption "${filename}"
#videoupload -t "${filename:0:50}" -c "${filename}" "${file}"
